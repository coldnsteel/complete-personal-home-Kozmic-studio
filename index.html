<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üíÄ Cosmic Trepanning Studio üåå</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(45deg, #1a1a2e, #16213e, #0f3460, #e73c7e, #23a6d5);
            background-size: 400% 400%;
            color: white;
            min-height: 100vh;
            animation: cosmicDance 8s ease-in-out infinite;
        }

        @keyframes cosmicDance {
            0% { background-position: 0% 50%; }
            25% { background-position: 100% 50%; }
            50% { background-position: 100% 100%; }
            75% { background-position: 0% 100%; }
            100% { background-position: 0% 50%; }
        }

        .header {
            text-align: center;
            padding: 20px;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 2.5em;
            background: linear-gradient(45deg, #ff6b9d, #4ecdc4, #ffd700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .module {
            background: rgba(44, 44, 78, 0.9);
            border: 2px solid #ff6b9d;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 0 20px rgba(255, 107, 157, 0.3);
            transition: all 0.3s ease;
        }

        .module:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 30px rgba(255, 107, 157, 0.5);
        }

        .module h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #ff6b9d;
            font-size: 1.4em;
        }

        .cosmic-visual {
            position: relative;
            width: 100%;
            height: 200px;
            background: linear-gradient(45deg, #2c2c4e, #1a1a2e);
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
            border: 2px solid #4ecdc4;
        }

        #webglCanvas {
            width: 100%;
            height: 100%;
            border-radius: 8px;
        }

        .overlay {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            padding: 8px;
            border-radius: 5px;
            font-size: 12px;
            color: #4ecdc4;
            z-index: 10;
        }

        .btn {
            background: linear-gradient(45deg, #ff6b9d, #4ecdc4);
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            color: white;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 157, 0.4);
        }

        .btn.active {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .control-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        select, input[type="range"] {
            background: rgba(44, 44, 78, 0.8);
            color: white;
            border: 2px solid #4ecdc4;
            padding: 10px;
            border-radius: 8px;
        }

        input[type="range"] {
            width: 100%;
            margin: 10px 0;
        }

        .status {
            background: rgba(0,0,0,0.5);
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #4ecdc4;
            font-family: monospace;
            font-size: 12px;
            margin-top: 10px;
        }

        .effects-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .effect-knob {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: radial-gradient(circle, #4ecdc4, #2c2c4e);
            border: 2px solid #ff6b9d;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0 auto;
        }

        .effect-knob:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(78, 205, 196, 0.8);
        }

        .effect-knob.off {
            background: radial-gradient(circle, #444, #222);
            filter: brightness(0.5);
        }

        .knob-label {
            text-align: center;
            font-size: 10px;
            margin-top: 5px;
            color: #4ecdc4;
        }

        .cosmic-creature {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: radial-gradient(circle, #ff6b9d, #4ecdc4);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            animation: float 3s ease-in-out infinite;
            z-index: 1000;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(180deg); }
        }

        .pulse-cosmic {
            animation: pulseCosmic 0.5s ease-in-out;
        }

        @keyframes pulseCosmic {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }

        .volume-bar {
            width: 100%;
            height: 20px;
            background: #2c2c4e;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .volume-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(to right, #4ecdc4, #ff6b9d);
            transition: width 0.1s ease;
        }

        @media (max-width: 768px) {
            .container { grid-template-columns: 1fr; padding: 10px; }
            .header h1 { font-size: 1.8em; }
            .control-row { justify-content: center; }
            .cosmic-creature { width: 50px; height: 50px; font-size: 20px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üíÄ COSMIC TREPANNING STUDIO üåå</h1>
        <p>üé∏ Enhanced Centrifuge ‚Ä¢ Mind Portals ‚Ä¢ Black Holes ‚Ä¢ Supernovas üé∏</p>
    </div>

    <div class="container">
        <!-- Cosmic Input Pod -->
        <div class="module">
            <h2>üåÄ Cosmic Input Portal</h2>
            <div class="controls">
                <select id="inputType">
                    <option value="cosmic-all">COSMIC ALL! üåå</option>
                    <option value="guitar">Guitar Portal üé∏</option>
                    <option value="mic">Mic Portal üéôÔ∏è</option>
                    <option value="trepan">Trepanning Mode üíÄ</option>
                </select>
                
                <div class="control-row">
                    <button class="btn" onclick="connectPortal()">Open Portal</button>
                    <button class="btn" id="trepanBtn" onclick="toggleTrepan()">TREPAN MODE üíÄ</button>
                </div>
                
                <div class="cosmic-visual">
                    <canvas id="webglCanvas"></canvas>
                    <div class="overlay" id="statusOverlay">Portal: Ready</div>
                </div>
                
                <div class="volume-bar">
                    <div class="volume-fill" id="volumeFill"></div>
                </div>
                
                <label>Cosmic Intensity:</label>
                <input type="range" id="intensity" min="1" max="100" value="75" oninput="updateIntensity(this.value)">
                
                <label>Effect Type:</label>
                <select id="effectType" onchange="changeEffect()">
                    <option value="particles">Frequency Particles</option>
                    <option value="blackhole">Black Hole Spiral üï≥Ô∏è</option>
                    <option value="supernova">Supernova Burst üåü</option>
                    <option value="trepan">Trepanning Portal üíÄ</option>
                    <option value="dance">Galaxy Dance</option>
                </select>
                
                <div class="status" id="inputStatus">üåÄ Ready for cosmic trepanning... Open portal to expand consciousness!</div>
            </div>
        </div>

        <!-- Enhanced Effects -->
        <div class="module">
            <h2>üéõÔ∏è Consciousness Effects</h2>
            <div class="controls">
                <div class="control-row">
                    <button class="btn" onclick="toggleEffect('reverb')">Nebula Reverb</button>
                    <button class="btn" onclick="toggleEffect('delay')">Time Delay</button>
                    <button class="btn" onclick="toggleEffect('trepan')">Trepan FX üíÄ</button>
                </div>
                
                <div class="effects-grid">
                    <div class="effect-knob" id="reverbKnob" onclick="toggleEffect('reverb')">
                        <div class="knob-label">Reverb</div>
                    </div>
                    <div class="effect-knob" id="delayKnob" onclick="toggleEffect('delay')">
                        <div class="knob-label">Delay</div>
                    </div>
                    <div class="effect-knob" id="trepanKnob" onclick="toggleEffect('trepan')">
                        <div class="knob-label">Trepan</div>
                    </div>
                </div>
                
                <label>Trepanning Level:</label>
                <input type="range" id="trepanLevel" min="1" max="10" value="5" oninput="setTrepanLevel(this.value)">
                
                <div class="status" id="effectStatus">üéõÔ∏è Effects ready! Trepan your way to cosmic consciousness!</div>
            </div>
        </div>

        <!-- Master Controls -->
        <div class="module">
            <h2>üéöÔ∏è Master Portal Controls</h2>
            <div class="controls">
                <div class="control-row">
                    <button class="btn" onclick="saveSession()">Save Session üíæ</button>
                    <button class="btn" id="recordBtn" onclick="toggleRecord()">Record Mix üéôÔ∏è</button>
                    <button class="btn" onclick="hypernovaMode()">HYPERNOVA üåã</button>
                </div>
                
                <div class="control-row">
                    <button class="btn" onclick="lowPowerMode()">Low Power üåô</button>
                    <button class="btn" onclick="emergencyStop()">Emergency Stop üõë</button>
                </div>
                
                <label>Master Volume:</label>
                <input type="range" id="masterVol" min="0" max="100" value="75" oninput="setVolume(this.value)">
                
                <div class="status" id="masterStatus">üéöÔ∏è Master controls ready - prepare for consciousness expansion!</div>
            </div>
        </div>

        <!-- Trepanning Debug -->
        <div class="module">
            <h2>üíÄ Trepanning Console</h2>
            <div class="controls">
                <div class="control-row">
                    <button class="btn" onclick="booleanCheck()">Portal Check ‚úÖ</button>
                    <button class="btn" onclick="openMindPortal()">Open Mind Portal üß†</button>
                    <button class="btn" onclick="crisisMode()">Crisis Mode üö®</button>
                </div>
                
                <div class="status" id="debugStatus">
                    üíÄ Trepanning: Ready<br>
                    Portals: 0 open<br>
                    Consciousness: Expanding...
                </div>
                
                <div id="trepanLog" style="background: rgba(0,0,0,0.6); padding: 10px; border-radius: 5px; font-size: 11px; max-height: 100px; overflow-y: auto; margin-top: 10px;">
                    üíÄ Cosmic Shredder: "Ready to drill consciousness portals?"<br>
                    üß† Inner Voice: "The trepanning begins the cosmic journey!"<br>
                    ‚ú® Higher Self: "Mind portals opening to infinite dimensions..."
                </div>
            </div>
        </div>
    </div>

    <div class="cosmic-creature" onclick="pulseCreature()">üíÄ</div>

    <script>
        // Core Variables
        let scene, camera, renderer, particles = [];
        let audioContext, analyzer, dataArray, guitarStream;
        let webglActive = false;
        let currentEffect = 'particles';
        let intensity = 75;
        let trepanMode = false;
        let trepanLevel = 5;
        let clickCount = 0;
        let lastClick = 0;
        let effects = { reverb: false, delay: false, trepan: false };

        // Initialize WebGL
        function initWebGL() {
            const canvas = document.getElementById('webglCanvas');
            if (!canvas) return false;

            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ canvas, alpha: true });
            renderer.setSize(canvas.clientWidth, canvas.clientHeight);
            renderer.setClearColor(0x000000, 0);
            camera.position.z = 5;

            createParticles();
            animate();
            
            logMessage("WebGL portal opened! Cosmic consciousness flowing!", 'success');
            return true;
        }

        function createParticles() {
            particles.forEach(p => scene.remove(p));
            particles = [];

            const count = Math.floor(intensity * 2);
            for (let i = 0; i < count; i++) {
                const geometry = new THREE.SphereGeometry(0.02, 8, 8);
                const material = new THREE.MeshBasicMaterial({ 
                    color: new THREE.Color().setHSL(Math.random(), 1, 0.5),
                    transparent: true,
                    opacity: 0.8
                });
                
                const particle = new THREE.Mesh(geometry, material);
                particle.position.set(
                    (Math.random() - 0.5) * 10,
                    (Math.random() - 0.5) * 6,
                    (Math.random() - 0.5) * 4
                );
                
                particle.userData = {
                    originalPos: particle.position.clone(),
                    speed: Math.random() * 0.02 + 0.01,
                    phase: Math.random() * Math.PI * 2
                };
                
                scene.add(particle);
                particles.push(particle);
            }
        }

        function animate() {
            if (!webglActive || !renderer) return;

            const time = Date.now() * 0.001;
            
            switch(currentEffect) {
                case 'particles':
                    animateParticles(time);
                    break;
                case 'blackhole':
                    animateBlackHole(time);
                    break;
                case 'supernova':
                    animateSupernova(time);
                    break;
                case 'trepan':
                    animateTrepan(time);
                    break;
                case 'dance':
                    animateDance(time);
                    break;
            }

            renderer.render(scene, camera);
            requestAnimationFrame(animate);
        }

        function animateParticles(time) {
            particles.forEach((p, i) => {
                const amplitude = dataArray ? (dataArray[i % dataArray.length] / 255) : Math.sin(time + i) * 0.5 + 0.5;
                p.position.x = p.userData.originalPos.x + Math.sin(time * p.userData.speed) * amplitude * 2;
                p.position.y = p.userData.originalPos.y + Math.cos(time * p.userData.speed) * amplitude * 2;
                p.position.z = p.userData.originalPos.z + Math.sin(time + i) * amplitude;
                
                p.material.color.setHSL((i / particles.length + time * 0.1) % 1, 1, 0.5 + amplitude * 0.5);
                p.scale.setScalar(0.5 + amplitude * 2);
            });
        }

        function animateBlackHole(time) {
            particles.forEach((p, i) => {
                let radius = 3 * Math.exp(-time * 0.3);
                if (radius < 0.1) radius = 3;
                
                const angle = time + i * 0.2;
                p.position.x = Math.cos(angle) * radius;
                p.position.y = Math.sin(angle) * radius;
                
                const hue = 0.7 - (radius / 3) * 0.3;
                p.material.color.setHSL(hue, 1, 0.5);
                p.material.opacity = radius > 0.5 ? 0.8 : 0.2;
            });
        }

        function animateSupernova(time) {
            const volume = dataArray ? (dataArray.reduce((a,b) => a+b, 0) / dataArray.length / 128 * 100) : Math.sin(time) * 50 + 50;
            
            if (volume > 80) {
                particles.forEach(p => {
                    const dir = new THREE.Vector3(Math.random()-0.5, Math.random()-0.5, Math.random()-0.5).normalize();
                    p.position.addScaledVector(dir, 0.1);
                    p.material.color.setHSL(0.1, 1, 0.8);
                    p.scale.setScalar(2);
                });
                logMessage("SUPERNOVA BURST! Consciousness exploding! üåü", 'error');
            } else {
                particles.forEach(p => {
                    p.position.lerp(p.userData.originalPos, 0.02);
                    p.scale.setScalar(1);
                });
            }
        }

        function animateTrepan(time) {
            const trepanIntensity = trepanLevel / 10;
            particles.forEach((p, i) => {
                const drillAngle = time * 2 + p.userData.phase;
                const radius = 1 + Math.sin(time + i) * trepanIntensity;
                
                p.position.x = Math.cos(drillAngle) * radius;
                p.position.y = Math.sin(drillAngle) * radius;
                p.position.z = Math.sin(time * 3 + i) * trepanIntensity * 2;
                
                p.material.color.setHSL(0.6 + Math.sin(time + i) * 0.1, 0.8, 0.7);
                p.scale.setScalar(0.5 + trepanIntensity * 2);
            });
        }

        function animateDance(time) {
            particles.forEach((p, i) => {
                const dancePhase = p.userData.phase + time;
                const radius = 3 + Math.sin(time + i) * 2;
                
                p.position.x = Math.cos(dancePhase) * radius;
                p.position.y = Math.sin(dancePhase * 1.3) * radius * 0.7;
                p.position.z = Math.sin(time * 3 + i) * 2;
                
                p.material.color.setHSL((dancePhase * 0.1) % 1, 1, 0.7);
                p.scale.setScalar(1 + Math.sin(time * 5) * 0.5);
            });
        }

        // Audio Setup
        async function initAudio() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyzer = audioContext.createAnalyser();
                analyzer.fftSize = 256;
                dataArray = new Uint8Array(analyzer.frequencyBinCount);
                logMessage("Audio portal opened! Cosmic frequencies ready!", 'success');
            } catch (e) {
                logMessage("Audio portal blocked: " + e.message, 'error');
            }
        }

        // Main Functions
        async function connectPortal() {
            try {
                await initAudio();
                
                guitarStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: { echoCancellation: false, noiseSuppression: false } 
                });
                
                const source = audioContext.createMediaStreamSource(guitarStream);
                source.connect(analyzer);
                
                if (!webglActive) {
                    webglActive = initWebGL();
                }
                
                startVolumeMonitor();
                document.getElementById('inputStatus').innerHTML = '‚ú® Cosmic portal opened! Consciousness flowing!';
                document.getElementById('statusOverlay').textContent = 'Portal: ACTIVE';
                logMessage("PORTAL CONNECTION ACHIEVED! Mind holes opened!", 'success');
                
            } catch (e) {
                document.getElementById('inputStatus').innerHTML = '‚ùå Portal blocked: ' + e.message;
                logMessage("Portal resistance: " + e.message, 'error');
            }
        }

        function startVolumeMonitor() {
            function updateVolume() {
                if (!analyzer || !dataArray) return;
                
                analyzer.getByteFrequencyData(dataArray);
                const sum = dataArray.reduce((a, b) => a + b, 0);
                const avg = sum / dataArray.length;
                const percent = Math.min((avg / 128) * 100, 100);
                
                document.getElementById('volumeFill').style.width = percent + '%';
                requestAnimationFrame(updateVolume);
            }
            updateVolume();
        }

        function toggleTrepan() {
            trepanMode = !trepanMode;
            const btn = document.getElementById('trepanBtn');
            
            if (trepanMode) {
                btn.textContent = 'STOP TREPAN ‚èπÔ∏è';
                btn.classList.add('active');
                currentEffect = 'trepan';
                document.getElementById('effectType').value = 'trepan';
                document.body.style.animation = 'cosmicDance 2s ease-in-out infinite';
                logMessage("TREPANNING ACTIVATED! Drilling consciousness portals! üíÄ", 'success');
            } else {
                btn.textContent = 'TREPAN MODE üíÄ';
                btn.classList.remove('active');
                currentEffect = 'particles';
                document.getElementById('effectType').value = 'particles';
                logMessage("Trepanning paused... but mind holes remain open!", 'info');
            }
            
            updateDebugStatus();
        }

        function updateIntensity(value) {
            intensity = parseInt(value);
            if (webglActive) createParticles();
            logMessage(`Cosmic intensity: ${value}% - consciousness density increasing!`, 'info');
        }

        function changeEffect() {
            currentEffect = document.getElementById('effectType').value;
            if (webglActive) createParticles();
            logMessage(`Effect changed to ${currentEffect} - reality transforms!`, 'success');
        }

        function setTrepanLevel(value) {
            trepanLevel = parseInt(value);
            updateDebugStatus();
            logMessage(`Trepan level ${value} - mind portal depth adjusted!`, 'info');
        }

        function toggleEffect(effect) {
            effects[effect] = !effects[effect];
            const knob = document.getElementById(effect + 'Knob');
            
            if (effects[effect]) {
                knob.classList.remove('off');
                knob.style.background = 'radial-gradient(circle, #4ecdc4, #2c2c4e)';
            } else {
                knob.classList.add('off');
                knob.style.background = 'radial-gradient(circle, #444, #222)';
            }
            
            document.getElementById('effectStatus').innerHTML = `üéõÔ∏è ${effect.toUpperCase()}: ${effects[effect] ? 'ACTIVE ‚ú®' : 'OFF'}`;
            logMessage(`${effect} effect ${effects[effect] ? 'activated' : 'deactivated'}!`, 'info');
        }

        function hypernovaMode() {
            currentEffect = 'supernova';
            document.getElementById('effectType').value = 'supernova';
            intensity = 100;
            document.getElementById('intensity').value = 100;
            trepanLevel = 10;
            document.getElementById('trepanLevel').value = 10;
            
            if (webglActive) createParticles();
            
            document.body.style.animation = 'cosmicDance 0.5s ease-in-out 5';
            setTimeout(() => {
                document.body.style.animation = 'cosmicDance 8s ease-in-out infinite';
            }, 2500);
            
            logMessage("HYPERNOVA MODE! Maximum consciousness explosion! üåãüíÄ", 'error');
            for (let i = 0; i < 5; i++) {
                setTimeout(() => pulseCreature(), i * 100);
            }
        }

        function lowPowerMode() {
            intensity = Math.min(intensity, 50);
            document.getElementById('intensity').value = intensity;
            if (webglActive) createParticles();
            logMessage("Low power mode - efficient consciousness processing!", 'info');
        }

        function emergencyStop() {
            webglActive = false;
            trepanMode = false;
            if (guitarStream) {
                guitarStream.getTracks().forEach(track => track.stop());
                guitarStream = null;
            }
            
            document.getElementById('inputStatus').innerHTML = 'üõë Emergency stop - all cosmic systems halted';
            document.getElementById('statusOverlay').textContent = 'Portal: CLOSED';
            document.getElementById('trepanBtn').textContent = 'TREPAN MODE üíÄ';
            document.getElementById('trepanBtn').classList.remove('active');
            
            logMessage("EMERGENCY STOP! All portals sealed safely!", 'error');
        }

        function booleanCheck() {
            const hasAudio = !!guitarStream;
            const hasWebGL = webglActive;
            const isTrepanning = trepanMode;
            
            updateDebugStatus();
            
            if (hasAudio && isTrepanning) {
                logMessage("Boolean check PASSED! Full consciousness expansion!", 'success');
            } else {
                logMessage("Boolean check shows opportunities for portal enhancement!", 'warning');
            }
        }

        function openMindPortal() {
            trepanLevel = Math.min(trepanLevel + 1, 10);
            document.getElementById('trepanLevel').value = trepanLevel;
            updateDebugStatus();
            logMessage(`Mind portal ${trepanLevel} opened! New consciousness channel!`, 'success');
            pulseCreature();
        }

        function crisisMode() {
            updateDebugStatus();
            logMessage("CRISIS MODE! When portals fail, we drill harder! üíÄüö®", 'error');
            logMessage("Universe grant us clear consciousness channels!", 'info');
            logMessage("Am I crazy for trepanning reality? NO! This is cosmic evolution!", 'warning');
            
            for (let i = 0; i < 3; i++) {
                setTimeout(() => pulseCreature(), i * 200);
            }
        }

        function updateDebugStatus() {
            const hasAudio = !!guitarStream;
            const hasWebGL = webglActive;
            const portals = trepanLevel;
            
            document.getElementById('debugStatus').innerHTML = `
                üíÄ Trepanning: ${trepanMode ? 'DRILLING ‚úÖ' : 'DORMANT ‚ùå'}<br>
                üåå Audio Portal: ${hasAudio ? 'OPEN ‚úÖ' : 'CLOSED ‚ùå'}<br>
                ‚ú® WebGL: ${hasWebGL ? 'SPINNING ‚úÖ' : 'STOPPED ‚ùå'}<br>
                üß† Mind Portals: ${portals} holes open<br>
                üöÄ Status: ${hasAudio && trepanMode ? 'CONSCIOUSNESS EXPANDED! üåü' : 'READY TO DRILL üîß'}
            `;
        }

        function saveSession() {
            const session = {
                effects: effects,
                intensity: intensity,
                currentEffect: currentEffect,
                trepanMode: trepanMode,
                trepanLevel: trepanLevel,
                timestamp: new Date().toISOString(),
                signature: 'üíÄ Trepanning Session üåå'
            };
            
            const blob = new Blob([JSON.stringify(session, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `trepan_session_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            document.getElementById('masterStatus').innerHTML = 'üíæ Trepanning session saved! Consciousness preserved!';
            logMessage("Session saved! Your portal configuration is eternal!", 'success');
        }

        function toggleRecord() {
            const btn = document.getElementById('recordBtn');
            // Recording functionality placeholder
            if (btn.textContent.includes('Record')) {
                btn.textContent = 'Stop Recording ‚èπÔ∏è';
                btn.classList.add('active');
                logMessage("Recording cosmic consciousness! Capturing portal frequencies!", 'success');
            } else {
                btn.textContent = 'Record Mix üéôÔ∏è';
                btn.classList.remove('active');
                logMessage("Recording stopped! Cosmic mix captured!", 'info');
            }
        }

        function setVolume(value) {
            document.getElementById('masterStatus').innerHTML = `üéöÔ∏è Master volume: ${value}% - consciousness amplitude set!`;
            logMessage(`Master volume: ${value}% - cosmic levels adjusted!`, 'info');
        }

        function pulseCreature() {
            const creature = document.querySelector('.cosmic-creature');
            const now = Date.now();
            
            if (now - lastClick < 1000) {
                clickCount++;
            } else {
                clickCount = 1;
            }
            lastClick = now;

            if (clickCount >= 5) {
                hypernovaMode();
                clickCount = 0;
                logMessage("5-CLICK HYPERNOVA! Secret portal unlocked! üíÄüåã", 'error');
            }

            creature.classList.add('pulse-cosmic');
            setTimeout(() => creature.classList.remove('pulse-cosmic'), 500);
            
            // Change creature based on mode
            if (trepanMode) {
                creature.textContent = 'üíÄ';
            } else if (currentEffect === 'supernova') {
                creature.textContent = 'üåü';
            } else if (currentEffect === 'blackhole') {
                creature.textContent = 'üï≥Ô∏è';
            } else {
                creature.textContent = 'üåå';
            }
        }

        function logMessage(message, type = 'info') {
            const log = document.getElementById('trepanLog');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#4ecdc4',
                success: '#27ae60',
                warning: '#f39c12',
                error: '#e74c3c'
            };
            const icons = {
                info: 'üåå',
                success: '‚ú®',
                warning: '‚ö†Ô∏è',
                error: 'üíÄ'
            };
            
            const msg = `<span style="color: ${colors[type]};">${icons[type]} [${timestamp}] ${message}</span><br>`;
            log.innerHTML += msg;
            log.scrollTop = log.scrollHeight;
            
            // Keep only last 5 messages
            const lines = log.innerHTML.split('<br>');
            if (lines.length > 5) {
                log.innerHTML = lines.slice(-5).join('<br>');
            }
        }

        // Canvas resize handling
        function handleResize() {
            if (renderer) {
                const canvas = document.getElementById('webglCanvas');
                const rect = canvas.getBoundingClientRect();
                renderer.setSize(rect.width, rect.height);
                camera.aspect = rect.width / rect.height;
                camera.updateProjectionMatrix();
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.shiftKey) {
                switch(e.key) {
                    case 'T':
                        toggleTrepan();
                        break;
                    case 'H':
                        hypernovaMode();
                        break;
                    case 'P':
                        openMindPortal();
                        break;
                    case 'B':
                        booleanCheck();
                        break;
                    case 'C':
                        crisisMode();
                        break;
                }
            }
        });

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üíÄüåå COSMIC TREPANNING STUDIO INITIALIZED! üååüíÄ');
            logMessage("TREPANNING STUDIO ONLINE! Ready to drill consciousness portals!", 'success');
            
            // Setup resize observer
            window.addEventListener('resize', handleResize);
            
            // Auto-start cosmic vibes
            setTimeout(() => {
                logMessage("System ready! Click 'Open Portal' to expand consciousness!", 'info');
                logMessage("We're trepanning together through cosmic dimensions! üíÄ‚ú®", 'success');
                pulseCreature();
            }, 1000);
        });

        // Global debug utilities
        window.cosmicTrepanDebug = {
            emergencyTrepan: () => {
                toggleTrepan();
                hypernovaMode();
                logMessage("EMERGENCY TREPANNING ACTIVATED! üíÄüö®", 'error');
            },
            
            openAllPortals: () => {
                trepanLevel = 10;
                document.getElementById('trepanLevel').value = 10;
                Object.keys(effects).forEach(e => {
                    effects[e] = true;
                    document.getElementById(e + 'Knob').classList.remove('off');
                });
                updateDebugStatus();
                logMessage("ALL PORTALS OPENED! Maximum consciousness! üß†üí•", 'success');
            },
            
            checkStatus: () => {
                console.log('Audio:', !!guitarStream);
                console.log('WebGL:', webglActive);
                console.log('Trepanning:', trepanMode);
                console.log('Portals:', trepanLevel);
                logMessage("System status checked! All cosmic frequencies verified!", 'info');
            }
        };

        // Expose key functions globally
        window.connectPortal = connectPortal;
        window.toggleTrepan = toggleTrepan;
        window.hypernovaMode = hypernovaMode;
        window.booleanCheck = booleanCheck;
        window.openMindPortal = openMindPortal;
    </script>
</body>
</html>
